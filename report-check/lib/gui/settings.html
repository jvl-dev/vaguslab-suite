<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="theme.css">
<link rel="stylesheet" href="components.css">
<script>
// Apply theme immediately (before paint) to prevent lightâ†’dark flash
(function() {
    var m = location.search.match(/[?&]theme=(dark|light)/);
    if (m) document.documentElement.dataset.theme = m[1];
})();
</script>
<style>
/* ============================================
   Report Check Settings - Modern UI
   ============================================ */

/* Titlebar - ensure Webdings font for window control buttons */
.titlebar-btn {
    font-family: Webdings;
}

/* Footer */
.footer {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding: 12px 16px;
    background: var(--color-bg-card);
    border-top: 1px solid var(--color-border);
    gap: 12px;
    flex-shrink: 0;
}

/* Main Layout - extends base body from components.css */
body {
    background: var(--color-bg);
    height: 100vh;
}

.main {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: var(--color-bg);
}

/* Tab Navigation */
.tab-nav {
    display: flex;
    background: var(--color-bg-card);
    border-bottom: 1px solid var(--color-border);
    padding: 0 12px;
    flex-shrink: 0;
    flex-wrap: wrap;
    gap: 0;
}
.tab-btn {
    padding: 10px 14px;
    cursor: pointer;
    border: none;
    background: none;
    color: var(--color-text-secondary);
    font-size: 12px;
    font-family: inherit;
    font-weight: 500;
    border-bottom: 2px solid transparent;
    transition: color var(--transition), border-color var(--transition), background var(--transition);
    white-space: nowrap;
}
.tab-btn:hover {
    color: var(--color-primary-hover);
    background: var(--color-bg-hint);
}
.tab-btn.active {
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
}

/* Tab Content */
.tab-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px 24px;
    scroll-behavior: smooth;
}
.tab-pane { display: none; }
.tab-pane.active { display: block; }

/* Form Controls - page-specific overrides (base styles in components.css) */
.form-group label { width: 140px; }
.form-group select,
.form-group input[type="text"],
.form-group input[type="password"] { max-width: 320px; }
.form-group-wide input[type="text"] { max-width: 100%; }

/* Segmented Control */
.segmented-control {
    display: flex;
    background: var(--color-bg-hint);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 3px;
    gap: 2px;
}
.segmented-btn {
    flex: 1;
    padding: 8px 16px;
    border: none;
    border-radius: calc(var(--radius) - 2px);
    background: transparent;
    color: var(--color-text-secondary);
    font-size: 13px;
    font-family: inherit;
    font-weight: 500;
    cursor: pointer;
    transition: background var(--transition), color var(--transition), box-shadow var(--transition);
}
.segmented-btn:hover {
    color: var(--color-text);
}
.segmented-btn.active {
    background: var(--color-bg-card);
    color: var(--color-primary);
    box-shadow: var(--shadow-segmented);
    border: 1px solid var(--color-primary);
}
.segment-description {
    font-size: 12px;
    color: var(--color-text-secondary);
    line-height: 1.5;
    margin-top: 12px;
}

/* Toggle Switches */
.toggle-group {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
    gap: 10px;
}
.toggle {
    position: relative;
    width: 40px;
    height: 22px;
    flex-shrink: 0;
}
.toggle input {
    opacity: 0;
    width: 0;
    height: 0;
    position: absolute;
}
.toggle-slider {
    position: absolute;
    cursor: pointer;
    inset: 0;
    background: var(--color-toggle-off);
    border-radius: 22px;
    transition: background 0.2s;
}
.toggle-slider::before {
    content: "";
    position: absolute;
    height: 16px;
    width: 16px;
    left: 3px;
    bottom: 3px;
    background: var(--color-toggle-knob);
    border-radius: 50%;
    transition: transform 0.2s;
    box-shadow: 0 1px 3px var(--color-toggle-shadow);
}
.toggle input:checked + .toggle-slider {
    background: var(--color-primary);
}
.toggle input:checked + .toggle-slider::before {
    transform: translateX(18px);
}
.toggle input:disabled + .toggle-slider {
    opacity: 0.4;
    cursor: not-allowed;
}
.toggle-label {
    font-size: 13px;
    color: var(--color-text);
    cursor: pointer;
}

/* Textarea */
textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--color-border-input);
    border-radius: var(--radius-sm);
    font-size: 12px;
    font-family: 'Consolas', 'Monaco', monospace;
    color: var(--color-text);
    background: var(--color-bg-hint);
    resize: vertical;
    outline: none;
    transition: border-color var(--transition), box-shadow var(--transition);
}
textarea:focus {
    border-color: var(--color-focus);
    box-shadow: 0 0 0 2px var(--color-focus-ring);
}

/* Save Indicator */
.save-indicator {
    font-size: 12px;
    color: var(--color-success);
    opacity: 0;
    transition: opacity 0.2s;
}
.save-indicator.visible {
    opacity: 1;
}

/* DICOM Lock Indicator */
.dicom-lock-indicator {
    display: none;
    align-items: center;
    gap: 5px;
    margin-right: auto;
    font-size: 11px;
    font-weight: 500;
    color: var(--color-text-muted);
    opacity: 0.7;
    user-select: none;
}
.dicom-lock-indicator.visible {
    display: flex;
}
.dicom-lock-indicator.locked {
    color: var(--color-success);
    opacity: 0.85;
}
.dicom-lock-indicator svg {
    flex-shrink: 0;
}

/* Warning Text */
.warning-text {
    color: var(--color-warning);
    font-size: 12px;
    margin-top: 8px;
    display: none;
}
.warning-text.visible {
    display: block;
}

/* API Status */
.api-status {
    font-size: 12px;
    padding: 6px 10px;
    border-radius: var(--radius-sm);
    margin-top: 8px;
}
.api-status.success {
    color: var(--color-success);
    background: var(--color-primary-light);
}
.api-status.error {
    color: var(--color-danger);
    background: var(--color-primary-light);
}

/* Hint Text */
.hint {
    font-size: 12px;
    color: var(--color-text-muted);
    margin-top: 4px;
    line-height: 1.4;
}
.hint-block {
    font-size: 12px;
    color: var(--color-text-secondary);
    margin-top: 12px;
    line-height: 1.5;
    padding: 10px 12px;
    background: var(--color-bg-hint);
    border-radius: var(--radius-sm);
    border: 1px solid var(--color-border);
}

/* Scrollbar (Chromium) */
.tab-content::-webkit-scrollbar {
    width: 8px;
}
.tab-content::-webkit-scrollbar-track {
    background: var(--color-bg);
}
.tab-content::-webkit-scrollbar-thumb {
    background: var(--color-scrollbar-thumb);
    border-radius: 4px;
}
.tab-content::-webkit-scrollbar-thumb:hover {
    background: var(--color-scrollbar-thumb-hover);
}

/* Modal Dialog System */
.modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: var(--color-overlay);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.15s ease;
}
.modal-overlay.active {
    display: flex;
    opacity: 1;
}
.modal-dialog {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    box-shadow: var(--shadow-elevated);
    width: 440px;
    max-width: 90vw;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transform: scale(0.95);
    transition: transform 0.15s ease;
}
.modal-overlay.active .modal-dialog {
    transform: scale(1);
}
.modal-header {
    display: flex;
    align-items: center;
    padding: 16px 20px 12px;
    border-bottom: 1px solid var(--color-border-light);
    font-size: 14px;
    font-weight: 600;
    color: var(--color-text);
}
.modal-body {
    padding: 16px 20px;
    font-size: 13px;
    color: var(--color-text-secondary);
    line-height: 1.6;
    overflow-y: auto;
    white-space: pre-line;
    flex: 1 1 auto;
    min-height: 0;
}
.modal-body ul {
    margin: 8px 0;
    padding-left: 20px;
}
.modal-body li {
    margin-bottom: 4px;
}
.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    padding: 12px 20px;
    border-top: 1px solid var(--color-border-light);
    flex-shrink: 0;
}

/* Update Progress Bar */
.update-progress {
    margin-top: 16px;
    padding: 12px 0;
}

.progress-bar-container {
    width: 100%;
    height: 8px;
    background: var(--color-bg-hint);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--color-primary), var(--color-primary-hover));
    width: 0%;
    transition: width 0.3s ease;
}

.progress-text {
    font-size: 13px;
    font-weight: 600;
    color: var(--color-primary);
    margin-top: 8px;
    text-align: center;
}

.progress-details {
    font-size: 12px;
    color: var(--color-text-secondary);
    margin-top: 4px;
    text-align: center;
}

/* Utility classes (replaces inline styles) */
.hidden { display: none; }
.flex-row { display: flex; gap: var(--space-xs); }
.flex-shrink-0 { flex-shrink: 0; }
.flex-fill { flex: 1; max-width: none; }
.mt-xs { margin-top: var(--space-xxs); }
.mt-sm { margin-top: var(--space-xs); }
.mt-md { margin-top: var(--space-sm); }
.label-auto { width: auto; white-space: nowrap; }
.line-height-relaxed { line-height: var(--line-height-relaxed); }
</style>
</head>
<body>

<!-- Titlebar -->
<div class="titlebar">
    <span class="titlebar-text">Report Check Settings</span>
    <span class="titlebar-btn" onclick="ahk.MinimizeWindow()" title="Minimize">0</span>
    <span class="titlebar-btn titlebar-btn-close" onclick="ahk.CloseSettings()" title="Close">r</span>
</div>

<div class="main">
<!-- Tab Navigation -->
<div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('mode', this)">Mode</button>
    <button class="tab-btn" onclick="switchTab('prompts', this)">Prompts</button>
    <button class="tab-btn" onclick="switchTab('api', this)">API</button>
    <button class="tab-btn" onclick="switchTab('beta', this)">Beta</button>
    <button class="tab-btn" onclick="switchTab('about', this)">About</button>
</div>

<!-- Tab Content -->
<div class="tab-content">

<!-- ==================== Mode Tab ==================== -->
<div id="tab-mode" class="tab-pane active">
    <div class="card">
        <div class="card-description">
            Select the review mode for your reports. This determines the type of analysis the AI will perform.
        </div>
    </div>

    <div class="card">
        <div class="card-header">Review Mode</div>
        <input type="radio" name="reviewMode" id="ModeComprehensive" value="comprehensive" class="hidden">
        <input type="radio" name="reviewMode" id="ModeProofreading" value="proofreading" class="hidden">
        <div class="segmented-control">
            <button type="button" class="segmented-btn active" data-mode="comprehensive" onclick="selectMode('comprehensive')">Comprehensive</button>
            <button type="button" class="segmented-btn" data-mode="proofreading" onclick="selectMode('proofreading')">Proofreading</button>
        </div>
        <div class="segment-description" id="modeDescription">
            Full analysis including clinical effectiveness, diagnostic reasoning, clarity, structure, technical accuracy, and proofreading. Best for complex report review before signing. If demographic and targeted review suggestions are enabled in beta settings this will trigger an additional API call.
        </div>
        <div id="modeGeminiWarning" class="warning-text">
            Note: Comprehensive mode defaults to paid 2.5 Pro. You can change to free 2.5 Flash in API tab.
        </div>
    </div>
</div>

<!-- ==================== Prompts Tab ==================== -->
<div id="tab-prompts" class="tab-pane">
    <div class="card">
        <div class="card-description">System prompts are stored locally and can be edited directly or restored to defaults. This should only be done by advanced users. Reload applies local edits. Restore downloads the latest defaults from the application server.</div>
    </div>

    <div class="card">
        <div class="card-header">System Prompts</div>
        <div class="flex-row">
            <button class="btn btn-secondary" onclick="ahk.ReloadFromFile()">Reload from File</button>
            <button class="btn btn-secondary" onclick="ahk.RestoreFromServer()">Restore from Server</button>
        </div>
    </div>
</div>

<!-- ==================== API Tab ==================== -->
<div id="tab-api" class="tab-pane">
    <div class="card">
        <div class="card-description">Configure API settings for AI providers.</div>
    </div>

    <div class="card">
        <div class="card-header">Provider</div>
        <div class="form-group">
            <label>AI Provider:</label>
            <select id="Provider">
                <option value="claude">Claude (Anthropic)</option>
                <option value="gemini">Gemini (Google)</option>
                <option value="openai">OpenAI</option>
            </select>
        </div>
    </div>

    <div class="card">
        <div class="card-header">API Key</div>
        <div class="form-group">
            <label id="apiKeyLabel">Key:</label>
            <input type="password" id="APIKey" placeholder="Enter your API key">
            <button class="btn btn-primary flex-shrink-0" onclick="ahk.TestAPIKey(JSON.stringify(collectFormData()))">Test</button>
        </div>
        <div id="apiStatus" class="api-status"></div>
    </div>

    <div class="card">
        <div class="card-header">Configuration</div>
        <div class="form-group form-group-wide">
            <label id="apiUrlLabel">API URL:</label>
            <input type="text" id="APIURL" placeholder="Default API URL">
        </div>
        <div class="form-group">
            <label id="modelLabel">Model:</label>
            <select id="Model">
                <!-- Populated dynamically based on provider -->
            </select>
        </div>
        <div class="toggle-group">
            <label class="toggle">
                <input type="checkbox" id="AutoVerify">
                <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Auto-verify API key when model changed</span>
        </div>
    </div>
</div>

<!-- ==================== Beta Tab ==================== -->
<div id="tab-beta" class="tab-pane">
    <div class="card">
        <div class="card-description">
            You must not use these features to send personally identifiable information. DICOM demographic extraction reads age, sex, modality, and study description and is required for targeted review. PHI always stays local and is never sent to the LLM API.
        </div>
    </div>

    <div class="card">
        <div class="card-header">Mode Override Hotkeys</div>
        <div class="toggle-group">
            <label class="toggle">
                <input type="checkbox" id="BetaModeOverrideHotkeys">
                <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Enable mode override hotkeys</span>
        </div>
        <div class="hint">Ctrl+F9 = Proofreading; Ctrl+F10 = Comprehensive</div>
    </div>

    <div class="card">
        <div class="card-header">PowerScribe Text Selection Automation</div>
        <div class="toggle-group">
            <label class="toggle">
                <input type="checkbox" id="BetaPowerScribeAutoselect">
                <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Enable PowerScribe auto-select</span>
        </div>
        <div class="hint">Automatically selects all text in PowerScribe when using review hotkeys.</div>
    </div>

    <div class="card">
        <div class="card-header">Demographic Information</div>
        <div class="toggle-group">
            <label class="toggle">
                <input type="checkbox" id="DemographicExtractionEnabled">
                <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Enable DICOM demographic information (experimental)</span>
        </div>
        <div class="form-group mt-xs">
            <label id="dicomCacheDirLabel" class="label-auto">DICOM cache:</label>
            <input type="text" id="DicomCacheDirectory" placeholder="Default directory" class="flex-fill">
            <button class="btn btn-secondary flex-shrink-0" id="dicomCacheBrowseBtn" onclick="ahk.BrowseDicomCache()">Browse</button>
        </div>
    </div>

    <div class="card hidden" id="TargetedReviewCard">
        <div class="card-header">Targeted Review Panel</div>
        <div class="toggle-group">
            <label class="toggle">
                <input type="checkbox" id="TargetedReviewEnabled">
                <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Enable targeted review areas (Comprehensive mode only)</span>
        </div>
        <div class="hint">
            Generates up to 5 anatomical focus areas (CT/MR/PET studies only).
        </div>
    </div>

</div>

<!-- ==================== About Tab ==================== -->
<div id="tab-about" class="tab-pane">
    <div class="card">
        <div class="card-header" id="aboutVersion">Report Check</div>
        <div class="hint">Experimental report review tool using LLMs. Use at your own risk. Ensure API keys are set up, select the preferred mode, and then highlight report text and press Ctrl + F11 to send for review.</div>
        <div class="hint mt-sm">
            View Documentation: (<a href="#" onclick="ahk.OpenReadme(); return false;">README.md</a>)
        </div>
        <div class="hint mt-sm">
            Contact: <a href="mailto:rad@vaguslab.org">rad@vaguslab.org</a>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Get API Keys</div>
        <div class="hint line-height-relaxed">
            <div>Claude: <a href="https://console.anthropic.com/" target="_blank">console.anthropic.com</a> (paid)</div>
            <div>Gemini: <a href="https://aistudio.google.com/app/apikey" target="_blank">aistudio.google.com/app/apikey</a> (free option)</div>
            <div>OpenAI: <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com/api-keys</a> (paid)</div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Appearance</div>
        <div class="toggle-group">
            <label class="toggle">
                <input type="checkbox" id="DarkModeEnabled" onchange="setTheme(this.checked ? 'dark' : 'light'); autoSave();">
                <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Dark mode</span>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Startup Options</div>
        <div class="toggle-group">
            <label class="toggle">
                <input type="checkbox" id="StartupEnabled">
                <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Launch Report Check when Windows starts</span>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Troubleshooting</div>
        <div class="toggle-group">
            <label class="toggle">
                <input type="checkbox" id="DebugLogging">
                <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Enable debug level logging</span>
        </div>
        <button class="btn btn-secondary mt-sm" onclick="ahk.DiagnoseKeys()">Diagnose &amp; Fix Stuck Keys</button>
    </div>

    <div class="card hidden" id="updateCard">
        <div class="card-header">Updates</div>
        <div class="version-text" id="updateStatusText">Current version: </div>
        <div class="update-info" id="updateAvailableText"></div>

        <!-- Progress visualization -->
        <div class="update-progress hidden" id="updateProgress">
            <div class="progress-bar-container">
                <div class="progress-bar" id="updateProgressBar"></div>
            </div>
            <div class="progress-text" id="updateProgressText">0%</div>
            <div class="progress-details" id="updateProgressDetails"></div>
        </div>

        <div class="flex-row mt-md">
            <button class="btn btn-primary" id="primaryUpdateBtn" onclick="ahk.OnUpdateClick()">Check for Updates</button>
            <button class="btn btn-secondary hidden" id="cancelUpdateBtn" onclick="ahk.CancelUpdate()">Cancel</button>
        </div>
    </div>
</div>

</div><!-- end tab-content -->

<!-- Footer -->
<div class="footer">
    <span class="dicom-lock-indicator" id="dicomLockIndicator"></span>
    <span class="save-indicator" id="saveIndicator">Settings saved</span>
    <button class="btn btn-primary" onclick="ahk.CloseSettings()">Close</button>
</div>

</div><!-- end main -->

<!-- Modal Dialog -->
<div class="modal-overlay" id="modalOverlay" onclick="onModalOverlayClick(event)">
    <div class="modal-dialog">
        <div class="modal-header">
            <span id="modalTitle"></span>
        </div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-footer" id="modalFooter"></div>
    </div>
</div>

<script>
/* ============================================
   Theme Management
   ============================================ */
function setTheme(mode) {
    document.documentElement.dataset.theme = mode;
}

/* ============================================
   Modal Dialog System
   ============================================ */
function showModal(title, body, icon, buttons) {
    const overlay = document.getElementById('modalOverlay');
    const titleEl = document.getElementById('modalTitle');
    const bodyEl = document.getElementById('modalBody');
    const footerEl = document.getElementById('modalFooter');

    titleEl.textContent = title;
    bodyEl.innerHTML = body;

    footerEl.innerHTML = '';
    (buttons || [{ label: 'OK', style: 'primary', action: 'close' }]).forEach(btn => {
        const el = document.createElement('button');
        el.className = 'btn btn-' + (btn.style || 'primary');
        el.textContent = btn.label;
        el.onclick = () => {
            hideModal();
            if (btn.action && btn.action !== 'close') {
                if (typeof ahk !== 'undefined' && typeof ahk[btn.action] === 'function') {
                    ahk[btn.action]();
                }
            }
        };
        footerEl.appendChild(el);
    });

    overlay.classList.add('active');
}

function hideModal() {
    document.getElementById('modalOverlay').classList.remove('active');
}

function onModalOverlayClick(event) {
    if (event.target === event.currentTarget) hideModal();
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.getElementById('modalOverlay').classList.contains('active')) {
        hideModal();
    }
});

/* ============================================
   Tab Switching
   ============================================ */
const switchTab = (tabId, btn) => {
    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-' + tabId).classList.add('active');
    btn.classList.add('active');
};

/* ============================================
   Form Data Collection
   ============================================ */
function collectFormData() {
    const val = id => document.getElementById(id)?.value || '';
    const chk = id => document.getElementById(id)?.checked || false;

    return {
        // Mode
        reviewMode: document.querySelector('input[name="reviewMode"]:checked')?.value || 'comprehensive',

        // API
        Provider: val('Provider'),
        APIKey: val('APIKey'),
        APIURL: val('APIURL'),
        Model: val('Model'),
        AutoVerify: chk('AutoVerify'),

        // Beta
        BetaModeOverrideHotkeys: chk('BetaModeOverrideHotkeys'),
        BetaPowerScribeAutoselect: chk('BetaPowerScribeAutoselect'),
        DemographicExtractionEnabled: chk('DemographicExtractionEnabled'),
        DicomCacheDirectory: val('DicomCacheDirectory'),
        TargetedReviewEnabled: chk('TargetedReviewEnabled'),

        // About / Settings
        StartupEnabled: chk('StartupEnabled'),
        DarkModeEnabled: chk('DarkModeEnabled'),
        DebugLogging: chk('DebugLogging')
    };
}

/* ============================================
   Auto-Save
   ============================================ */
let _autoSaveTimer = null;
let _saveIndicatorTimer = null;
function autoSave() {
    clearTimeout(_autoSaveTimer);
    _autoSaveTimer = setTimeout(function() {
        ahk.AutoSaveSettings(JSON.stringify(collectFormData()));
        var el = document.getElementById('saveIndicator');
        el.classList.add('visible');
        clearTimeout(_saveIndicatorTimer);
        _saveIndicatorTimer = setTimeout(function() { el.classList.remove('visible'); }, 1500);
    }, 300);
}

function initAutoSaveListeners() {
    document.querySelectorAll('input, select, textarea').forEach(function(el) {
        var evt = (el.type === 'text' || el.type === 'password' || el.tagName === 'TEXTAREA') ? 'input' : 'change';
        el.addEventListener(evt, autoSave);
    });
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAutoSaveListeners);
} else {
    initAutoSaveListeners();
}

/* ============================================
   Helper Functions (called from AHK)
   ============================================ */
function setSelectValue(id, value) {
    const el = document.getElementById(id);
    if (el) el.value = value;
}

function setCheckbox(id, checked) {
    const el = document.getElementById(id);
    if (el) el.checked = checked;
}

function setRadio(name, value) {
    const el = document.querySelector(`input[name="${name}"][value="${value}"]`);
    if (el) el.checked = true;
    if (name === 'reviewMode') syncSegmentedControl(value);
}

const MODE_DESCRIPTIONS = {
    comprehensive: 'Full analysis including clinical effectiveness, diagnostic reasoning, clarity, structure, technical accuracy, and proofreading. Best for complex report review before signing. If demographic and targeted review suggestions are enabled in beta settings this will trigger an additional API call.',
    proofreading: 'Fast check for broad content, spelling, grammar, punctuation, transcription, and mathematical mistakes only. Does not critique clinical content or style. Best for catching errors before final review.'
};

function selectMode(mode) {
    const radio = document.getElementById(mode === 'comprehensive' ? 'ModeComprehensive' : 'ModeProofreading');
    if (radio) {
        radio.checked = true;
        radio.dispatchEvent(new Event('change', { bubbles: true }));
    }
    syncSegmentedControl(mode);
}

function syncSegmentedControl(mode) {
    document.querySelectorAll('.segmented-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
    });
    const desc = document.getElementById('modeDescription');
    if (desc) desc.textContent = MODE_DESCRIPTIONS[mode] || '';
}

function setText(id, text) {
    const el = document.getElementById(id);
    if (el) el.innerText = text;
}

function setHTML(id, html) {
    const el = document.getElementById(id);
    if (el) el.innerHTML = html;
}

function setStyle(id, prop, value) {
    const el = document.getElementById(id);
    if (el) el.style[prop] = value;
}

function setDisabled(id, disabled) {
    const el = document.getElementById(id);
    if (el) el.disabled = disabled;
}

function setValue(id, value) {
    const el = document.getElementById(id);
    if (el) el.value = value;
}

function updateDicomLockStatus(isEnabled, isLocked) {
    var el = document.getElementById('dicomLockIndicator');
    if (!el) return;
    if (!isEnabled) {
        el.classList.remove('visible');
        return;
    }
    var lockSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>';
    var unlockSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></svg>';
    el.innerHTML = isLocked ? lockSvg : unlockSvg;
    el.classList.add('visible');
    el.classList.toggle('locked', isLocked);
}

/* ============================================
   Provider Change Handler
   ============================================ */
document.addEventListener('DOMContentLoaded', function() {
    const providerSelect = document.getElementById('Provider');
    const demographicCheckbox = document.getElementById('DemographicExtractionEnabled');

    if (providerSelect) {
        providerSelect.addEventListener('change', function() {
            updateModeWarning();
        });
    }

    if (demographicCheckbox) {
        demographicCheckbox.addEventListener('change', function() {
            updateDependencies();
        });
    }

    // Initialize mode radio handlers
    const modeRadios = document.querySelectorAll('input[name="reviewMode"]');
    modeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            updateModeWarning();
        });
    });
});

function updateModeWarning() {
    const provider = document.getElementById('Provider')?.value;
    const mode = document.querySelector('input[name="reviewMode"]:checked')?.value;
    const warning = document.getElementById('modeGeminiWarning');

    if (warning) {
        if (provider === 'gemini' && mode === 'comprehensive') {
            warning.classList.add('visible');
        } else {
            warning.classList.remove('visible');
        }
    }
}

function updateDependencies() {
    const isEnabled = document.getElementById('DemographicExtractionEnabled')?.checked || false;

    setDisabled('DicomCacheDirectory', !isEnabled);
    setDisabled('dicomCacheBrowseBtn', !isEnabled);

    // Show/hide targeted review card based on demographic extraction
    const trCard = document.getElementById('TargetedReviewCard');
    if (trCard) {
        trCard.classList.toggle('hidden', !isEnabled);
    }

    const label = document.getElementById('dicomCacheDirLabel');
    if (label) {
        label.style.opacity = isEnabled ? '1' : '0.5';
    }
}
</script>

</body>
</html>
