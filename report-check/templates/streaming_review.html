<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Check - Reviewing...</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap">
    <script>
    // Apply theme + load shared CSS immediately (before paint) to prevent FOUC
    (function() {
        var p = new URLSearchParams(location.search);
        if (p.get('theme')) document.documentElement.dataset.theme = p.get('theme');
        var s = p.get('shared') || '../lib/gui';
        document.write('<link rel="stylesheet" href="' + s + '/theme.css">');
        document.write('<link rel="stylesheet" href="../lib/gui/rc-theme.css">');
    })();
    </script>
    <style>
        * { box-sizing: border-box; }

        body {
            font-family: 'Outfit', var(--font-family-base);
            font-size: var(--font-size-base);
            line-height: var(--line-height-base);
            margin: 0;
            padding: var(--spacing-md);
            background: var(--color-bg);
            color: var(--color-text);
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header — matches review template */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 2px solid var(--color-border);
        }

        .header h1 {
            font-family: 'Outfit', var(--font-family-base);
            font-size: 26px;
            font-weight: 600;
            color: var(--color-h1);
            margin: 0;
            letter-spacing: -0.02em;
        }

        .version {
            font-size: 11px;
            color: var(--color-text-muted);
            font-weight: 500;
            letter-spacing: 0.03em;
            padding: 4px 10px;
            background: var(--color-accent-bg);
            border-radius: 6px;
            border: 1px solid var(--color-accent-border);
        }

        /* Loading state */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 80px var(--spacing-md) var(--spacing-md);
        }

        .loading-text {
            font-size: 15px;
            font-weight: 500;
            color: var(--color-text-secondary);
            margin-bottom: 20px;
            letter-spacing: 0.01em;
        }

        .loading-bar {
            width: 48px;
            height: 3px;
            border-radius: 2px;
            background: var(--color-primary);
            opacity: 0.6;
            animation: loadingPulse 1.6s ease-in-out infinite;
        }

        @keyframes loadingPulse {
            0%, 100% { opacity: 0.25; width: 48px; }
            50% { opacity: 0.7; width: 64px; }
        }

        /* Streaming section entrance */
        @keyframes fadeSlideIn {
            from { opacity: 0; transform: translateY(12px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .stream-enter {
            animation: fadeSlideIn 0.4s ease-out both;
        }

        /* Error entrance */
        .error-enter {
            animation: fadeSlideIn 0.3s ease-out both;
        }

        /* Report sections — matches review template */
        .report-section {
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-card);
        }

        .original-report-header {
            font-size: 24px;
            font-weight: 600;
            color: var(--color-h2);
            margin: 0 0 var(--spacing-md) 0;
            padding-bottom: var(--spacing-xs);
            border-bottom: 2px solid var(--color-border);
        }

        .analysis-content {
            background: var(--color-bg);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
            border: 1px solid var(--color-border);
        }

        /* Typography — matches review template */
        h1, h2, h3 {
            font-family: 'Outfit', var(--font-family-base);
            line-height: var(--line-height-tight);
            margin-top: 0;
        }

        h2.section-header {
            font-size: 20px;
            color: var(--color-h2);
            padding: 4px 8px;
            background: var(--color-accent-bg);
            border-left: 4px solid var(--color-border-accent);
            border-radius: var(--border-radius);
            margin: var(--spacing-md) 0;
        }

        h3.section-header {
            font-size: 16px;
            color: var(--color-h3);
            display: inline-block;
            padding: 4px 8px;
            background: var(--color-accent-bg);
            border-left: 4px solid var(--color-border-accent);
            border-radius: var(--border-radius);
            margin: var(--spacing-md) 0;
        }

        p { margin: 0 0 var(--spacing-md) 0; }

        strong, .highlight {
            color: var(--color-highlight);
            font-weight: 600;
        }

        em {
            color: var(--color-text-secondary);
            font-style: italic;
        }

        code {
            font-family: var(--font-family-mono);
            font-size: 14px;
            background: var(--color-bg);
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid var(--color-border);
            color: var(--color-code);
        }

        ul, ol {
            margin: var(--spacing-md) 0;
            padding-left: var(--spacing-lg);
        }

        li {
            margin-bottom: var(--spacing-xs);
            line-height: var(--line-height-base);
        }

        li::marker { color: var(--color-border-accent); }

        .review-list {
            margin-left: var(--spacing-md);
            padding-left: var(--spacing-md);
        }

        /* Streaming cursor blink */
        .streaming-cursor {
            display: inline-block;
            width: 2px;
            height: 1em;
            background: var(--color-border-accent);
            margin-left: 2px;
            vertical-align: text-bottom;
            animation: cursorBlink 1s step-end infinite;
        }

        @keyframes cursorBlink {
            50% { opacity: 0; }
        }

        /* Error display */
        .stream-error {
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: var(--spacing-md) var(--spacing-md);
            margin-top: var(--spacing-md);
            box-shadow: var(--shadow-card);
        }

        .stream-error .error-icon {
            font-size: 36px;
            margin-bottom: var(--spacing-sm);
        }

        .stream-error .error-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-danger);
            margin-bottom: var(--spacing-xs);
        }

        .stream-error .error-message {
            font-size: var(--font-size-base);
            color: var(--color-text);
            line-height: var(--line-height-base);
        }

        /* Accessibility: reduce motion */
        @media (prefers-reduced-motion: reduce) {
            .loading-bar { animation: none; opacity: 0.5; }
            .streaming-cursor { animation: none; opacity: 1; }
            .stream-enter, .error-enter { animation: none; }
        }

        /* Footer — matches review template */
        .footer {
            text-align: center;
            margin-top: var(--spacing-xl);
            padding-top: var(--spacing-md);
            border-top: 1px solid var(--color-border);
        }

        .footer-brand {
            font-size: 13px;
            color: var(--color-text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Report Check</h1>
            <span class="version">Reviewing...</span>
        </div>

        <!-- Loading state (shown until first token) -->
        <div id="loadingState" class="loading-state">
            <div class="loading-text">Analyzing report...</div>
            <div class="loading-bar"></div>
        </div>

        <!-- Streaming content (shown when tokens arrive) -->
        <div id="streamingSection" class="report-section" style="display:none;">
            <h2 class="original-report-header">Analysis</h2>
            <div class="analysis-content" id="streamingContent">
                <span class="streaming-cursor"></span>
            </div>
        </div>

        <!-- Error display -->
        <div id="errorSection" class="stream-error" style="display:none;"></div>

        <div class="footer">
            <div class="footer-brand">Built by vaguslab</div>
        </div>
    </div>

    <script>
        var _streamAccumulator = '';
        var _streamingStarted = false;

        function appendStreamChunk(text) {
            _streamAccumulator += text;

            // On first chunk, switch from skeleton to streaming content
            if (!_streamingStarted) {
                _streamingStarted = true;
                document.getElementById('loadingState').style.display = 'none';
                var section = document.getElementById('streamingSection');
                section.style.display = 'block';
                section.classList.add('stream-enter');
                // Update header badge
                document.querySelector('.version').textContent = 'Streaming...';
            }

            var contentEl = document.getElementById('streamingContent');
            if (contentEl) {
                contentEl.innerHTML = convertMarkdownToHtml(_streamAccumulator)
                    + '<span class="streaming-cursor"></span>';
            }
        }

        function streamComplete() {
            // Remove cursor, finalize content
            var contentEl = document.getElementById('streamingContent');
            if (contentEl) {
                contentEl.innerHTML = convertMarkdownToHtml(_streamAccumulator);
            }
            document.querySelector('.version').textContent = 'Loading final view...';
        }

        function streamError(msg) {
            document.getElementById('loadingState').style.display = 'none';
            // Hide streaming section if it was shown
            document.getElementById('streamingSection').style.display = 'none';

            var errorEl = document.getElementById('errorSection');
            var title = classifyErrorTitle(msg);
            errorEl.innerHTML = '<div class="error-icon">\u26A0</div>'
                + '<div class="error-title">' + escapeHtml(title) + '</div>'
                + '<div class="error-message">' + escapeHtml(msg) + '</div>';
            errorEl.style.display = 'block';
            errorEl.classList.add('error-enter');
            document.querySelector('.version').textContent = 'Error';
        }

        function classifyErrorTitle(msg) {
            var m = msg.toLowerCase();
            if (m.indexOf('rate limit') !== -1 || m.indexOf('quota') !== -1) return 'Rate Limit Reached';
            if (m.indexOf('authentication') !== -1 || m.indexOf('api key') !== -1) return 'Authentication Error';
            if (m.indexOf('connect') !== -1 || m.indexOf('timeout') !== -1 || m.indexOf('timed out') !== -1) return 'Connection Error';
            if (m.indexOf('server error') !== -1 || m.indexOf('unavailable') !== -1) return 'Service Unavailable';
            return 'Something Went Wrong';
        }

        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /* Client-side Markdown to HTML (matches review template) */
        function convertMarkdownToHtml(text) {
            var html = text;
            html = html.replace(/\r\n/g, '\n');

            html = html.replace(/^### (.+)$/gm, '<h3 class="section-header">$1</h3>');
            html = html.replace(/^## (.+)$/gm, '<h2 class="section-header">$1</h2>');
            html = html.replace(/^# (.+)$/gm, '<h1 class="section-header">$1</h1>');

            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong class="highlight">$1</strong>');
            html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            html = html.replace(/^[-*_]{3,}$/gm, '');

            var lines = html.split('\n');
            var result = [];
            var inList = false;

            for (var i = 0; i < lines.length; i++) {
                var line = lines[i].trim();

                if (/^<h[1-6]/.test(line)) {
                    if (inList) { result.push('</ul>'); inList = false; }
                    result.push(line);
                } else if (/^[-*+]\s+(.+)$/.test(line)) {
                    var m = line.match(/^[-*+]\s+(.+)$/);
                    if (!inList) { result.push('<ul class="review-list">'); inList = true; }
                    result.push('<li>' + m[1] + '</li>');
                } else if (/^\d+\.\s+(.+)$/.test(line)) {
                    var m = line.match(/^\d+\.\s+(.+)$/);
                    if (!inList) { result.push('<ul class="review-list">'); inList = true; }
                    result.push('<li>' + m[1] + '</li>');
                } else if (line && line !== '.') {
                    if (inList && !/^\s/.test(line) && line.length > 10) {
                        result.push('</ul>');
                        inList = false;
                    }
                    result.push('<p>' + line + '</p>');
                } else {
                    if (inList) { result.push('</ul>'); inList = false; }
                }
            }
            if (inList) result.push('</ul>');
            return result.join('\n');
        }
    </script>
</body>
</html>
